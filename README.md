pnong-shading
=============

Моя лабораторная работа по компьютерной графике. ТРТУ. 2005 г.


Затенение по Фонгу основывается на том, что количество света, отраженного от поверхности прямо пропорционально косинусу угла между нормалью к поверхности и направлением света. При этом не имеет значения, под каким углом вы смотрите на поверхность. 

В реальности очень немногие поверхности обладают такими идеальными свойствами. Наиболее подходящими являются поверхности, имеющие микроскопические шероховатости, например, хорошо отшлифованное дерево. Большинство поверхностей также обладают некоторой степенью спектрального отражения. Затенение по Фонгу не разделяет их между собой. Оно также не учитывает тот факт, что яркость обратно пропорциональна квадрату расстояния от источника света.
 
Итак, мы имеем полигон. В каждой вершине полигона мы имеем вектор нормали к поверхности, частью которой полигон является (v1, v2, v3). Эти векторы интерполированы по всей площади полигона, подобно тому, как это делалось в алгоритме затенения Гуро. В затенении Гуро, однако, мы имели дело только с одним значением -shade (это скалярная величина). Здесь же мы оперируем вектором с тремя значениями Vx, Vy и Vz (три значения, три координаты - определяющие положение вектора в пространстве). 
Итак, возьмем пиксель на этом полигоне. Вектор нормали, соответствующий этому пикселю на поверхности - n. Свет падает на полигон вдоль вектора l. Количество света, отраженного от данного пикселя, является функцией, называемой скалярное произведение векторов. Скалярное произведение вектора n(x,y,z) и вектора l(x,y,z) может производиться по любой из двух формул: 
n*l = nxlx + nyly + nzlz (1) 
n*l = |n|*|l| cosq (2), где q - угол между векторами.
Нам больше подходит второй вариант, т.к он оперирует с длинами (величинами) векторов и углом между ними. Величина нормали к поверхности равна 1. А величина вектора падающего света приводится к 1 и будет иметь значения от 0 до 1. 1 самый яркий свет. 
Далее результатом вычисления данной функции будет значение в диапазоне от -1 до 1, где 1 соответствует максимальной яркости. Понятия отрицательного света не существует, поэтому значения меньше 0 следует понимать как 0. Если вы затем умножите данное значение на величину яркости света, вы получите значение яркости нашего пикселя.
Быстрое затенение по Фонгу
Базовый алгоритм затенения по Фонгу требует больших вычислительных ресурсов и поэтому очень медлен. Однако эффект от применения этого затенения очень привлекателен, поэтому сам алгоритм неоднократно подвергался различным оптимизациям. Оптимизировать можно только базовый, главный алгоритм, и как не сокращай количество операций с фиксированной точкой или сколько не создавай заранее просчитанных таблиц, все равно в приложениях реального времени аппроксимации по Фонгу являются существенным "тормозом". 
Один из вариантов упрощения, активно обсуждаемый в кругах трехмерной графики - это способ, заключающийся в интерполяции угла между нормалью и направлением света вместо базовой интерполяции самого вектора нормали по всему полигону. Это отличная идея с одним лишь минусом - фактически, она не дает ничего. По существу, это воспроизводство затенения Гуро (т.к. интерполируется скалярная величина), и поэтому и пользы от него мало.
Однако этот способ дал толчок для развития мысли в правильном направлении, и было предложено интерполировать не один лишь угол, а сразу два. Это будет очень напоминать интерполяцию вектора. Далее, вместо проделывания целого ряда тяжелейших вычислений с этими двумя углами, можно рассмотреть эти углы как соответствие координатам на заранее просчитанной карте (текстуре) затенения. 
Карта тени для Phong shading
Карта для затенения по Фонгу (Phong Map) представляет собой заранее просчитанный набор яркостей для всех возможных нормалей. 
Как ни странно, карта тени - это очень несложная текстура. Удобно использовать текстуру размерностью 256х256 пикселей. Вот она.
 
Итак, для каждой из вершин подготовленного к визуализации полигона вы должны просчитать координаты соответствующей позиции на карте затенения. Для этого полигона определим два вектора, находящихся под прямым углом друг к другу и к нормали полигона. Назовем их V и H. Эти два вектора будут определять координаты u, v карты затенения (текстуры). Вспоминаем, что у текстур в 3х мерной графике своя система координат- (u, v).
Теперь расположим полигон в пространстве таким образом, что нам можно представить вектор света к нашей вершине. Это будет вектор L. 
Наша цель - получить координаты u и v исходя из значений V, H, L.
Алгоритм очень прост. Если карта затенения будет размерностью 256х256 с точным центром, то: 
u = ( V * L ) * 128 + 127 
v = ( H * L ) * 128 + 127 
Просчитайте это для каждой вершины, а затем "натяните" карту затенения на полигон - вы получите плавно затененный полигон в соответствии с внешним освещением. 
Можно еще более упростить и ускорить процесс вычислений, если допустить, что источник света находится в той же точке, где и камера. В этом случае мы можем игнорировать сами векторы V и H, а вместо них использовать координаты x и y, компоненты вектора нормали. Умножим на 128 и прибавим 127. Все.
